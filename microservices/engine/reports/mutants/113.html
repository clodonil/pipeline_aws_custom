<!DOCTYPE html>
<html>
<head>
    <title>MutPy mutation report - mutation #113</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    
<link href="http://alexgorbatchev.com/pub/sh/current/styles/shCore.css" rel="stylesheet" type="text/css" />
<link href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" rel="stylesheet" type="text/css" />

    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js" type="text/javascript"></script>
<script src="http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPython.js" type="text/javascript"></script>
<script type="text/javascript">
    SyntaxHighlighter.all();
    window.setTimeout(function () {
        
        $('.line.number103').attr('title', 'CRP');
        
    }, 0);
</script>

</head>
<body>
    <div class="container">
        
<div class="page-header">
    <h1>Mutation #113</h1>
</div>
<h3>Details</h3>
<ul>
    <li>module - <code><module 'pipeline_template' from '/home/clodonil/Dados/Workspace/Wasabi/microservices/engine/templates/pipeline_template.py'></code></li>
    <li><span class="label label-success">killed</span> by <code>tests/test_template.py::TestCodePipeline::test_deve_retornar_codebuild_do_template_app_ecs_com_action_customizado</code></li>
    
    <li>duration - 0.386 s</li>
    
    
    <li>tests run - -22</li>
    
</ul>

<h3>Exception traceback</h3>
<pre>self = <tests.test_template.TestCodePipeline object at 0x7f239028ef28>
params = {'action': {'configuration': {'InputArtifacts': 'App', 'PrimarySource': 'App', 'ProjectName': 'proj', 'runorder': '1'}...ole': 'arn:aws:iam::033921349789:role/RoleCodepipelineRole', 'runorder': 1, ...}, 'stage': {'name': 'Compilador'}, ...}
imageCustom = {'Aqua': {'all': 'imagem_Aqua'}, 'Build': {'all': 'image_Build', 'python37': 'image_custom'}, 'Fortify': {'all': 'imagem_sast'}, 'Sonar': {'all': 'imagem_sonar'}, ...}

    def test_deve_retornar_codebuild_do_template_app_ecs_com_action_customizado(self, params, imageCustom):
        for pipe in params['templates']:
            env = 'develop'
            name_template = pipe
            template_pipeline = self.load_template(name_template, env)
            dados = self.gettemplate('payload_5.yml', env)
            app = NewTemplate('codepipeline_role', 'codebuild_role', 'DevSecOps_Role')
>           cf_pipeline = app.generate_codebuild(dados['runtime'], template_pipeline, dados['stages'], dados['params'], env, imageCustom)

tests/test_template.py:189: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
pipeline_template:138: in generate_codebuild
    ???
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <pipeline_template.NewTemplate object at 0x7f23905aaf28>
list_yaml = [{'source': 'Build'}, {'environment': [{'Name': 'chave'}, {'Value': 'valor'}]}, {'imagecustom': 'linuxcustom'}, {'runorder': 4}]

>   ???
E   KeyError: ''

pipeline_template:103: KeyError</pre>

<h3>Mutations</h3>
<ul>
    
    <li>CRP - line 103</li>
    
</ul>
<h3>Mutant</h3>
<pre class="brush: python; first-line: 1; highlight: [103]; toolbar: false;">from troposphere import Template, Parameter, ec2, Ref
from templates.codepipeline.pipeline import NewPipeline
from templates.codebuild.newcodebuild import NewCodeBuild
from tools.config import VPCID, PrivateSubnetOne, PrivateSubnetTwo, DevAccount, HomologAccount, ProdAccount, KMSKeyArn, TokenAqua, DevSecOpsAccount, DevToolsAccount











import os


class NewTemplate:
    def __init__(self, codepipeline_role, codebuild_role, DevSecOps_Role):
        self.codepipeline_role = codepipeline_role
        self.codebuild_role = codebuild_role
        self.DevSecOps_Role = DevSecOps_Role
    
    def pipeline_parameter(self):
        
        params_vpcid = Parameter(
            'VPCID', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            VPCID)
        
        params_subnet1 = Parameter(
            'PrivateSubnetOne', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            PrivateSubnetOne)
        
        params_subnet2 = Parameter(
            'PrivateSubnetTwo', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            PrivateSubnetTwo)
        
        params_DevAccount = Parameter(
            'DevAccount', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            DevAccount)
        
        params_HomologAccount = Parameter(
            'HomologAccount', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            HomologAccount)
        
        params_ProdAccount = Parameter(
            'ProdAccount', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            ProdAccount)
        
        params_KMSKeyArn = Parameter(
            'KMSKeyArn', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            KMSKeyArn)
        
        params_TokenAqua = Parameter(
            'TokenAqua', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            TokenAqua)
        
        params_DevSecOpsAccount = Parameter(
            'DevSecOpsAccount', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            DevSecOpsAccount)
        
        params_DevToolsAccount = Parameter(
            'DevToolsAccount', Type=\
            'AWS::SSM::Parameter::Value<String>', Default=\
            DevToolsAccount)
        
        list_params = [\
            params_vpcid, \
            params_subnet1, \
            params_subnet2, \
            params_DevAccount, \
            params_HomologAccount, \
            params_ProdAccount, \
            params_KMSKeyArn, \
            params_TokenAqua, \
            params_DevSecOpsAccount, \
            params_DevToolsAccount]
        
        return list_params
    
    def getparams_codebuild(self, list_yaml):
        retorno = {}
        for params in list_yaml:
            if 'source' in params:
                retorno['source'] = params['source']
            elif 'runorder' in params:
                retorno['runorder'] = str(params['runorder'])
            elif 'imagecustom' in params:
                retorno['imagemcustom'] = params['imagecustom']
            elif 'environment' in params:
                env = {}
                if ('environment' in params and params['environment'] != None):
                    for dic_params in params['']:
                        env.update(dic_params)
                retorno['env'] = env
        return retorno
    
    def generate_codebuild(self, runtime, pipeline_template, stages, params, env, imageCustom):
        projeto = params['Projeto']
        (featurename, microservicename) = projeto.split('-')
        list_codebuild = []
        buildcustom = False
        if 'BuildCustom' in params:
            if params['BuildCustom'] == 'True':
                buildcustom = True
        codebuild = NewCodeBuild(self.codebuild_role)
        cont_stage = 0
        action_custom = 1
        for t_codebuild in stages:
            stage_custom_used = False
            if isinstance(t_codebuild, str):
                t_build_template = [item for item in pipeline_template if item.split('-')[1] == t_codebuild][0]
                if t_codebuild.lower() != 'source':
                    for l_codebuild_template in pipeline_template[t_build_template]:
                        for g_codebuild in l_codebuild_template:
                            new_codebuild = eval(f'codebuild.{g_codebuild}(featurename=featurename,microservicename=microservicename,runtime=runtime,branchname=env, custom=buildcustom, imageCustom=imageCustom)')
                            list_codebuild.append(new_codebuild)
            
            elif isinstance(t_codebuild, dict):
                name_custom_stage = list(t_codebuild.keys())[0]
                custom = name_custom_stage.split('::')
                stages_temp = []
                
                if (custom[-1].lower() == 'custom' and custom[0].lower() != 'source'):
                    for list_yaml in t_codebuild[name_custom_stage]:
                        temp_name = list(list_yaml.keys())[0]
                        imagemcustom = False
                        params = self.getparams_codebuild(list_yaml[temp_name])
                        configuration = {\
                            temp_name: {\
                            'ProjectName': temp_name, \
                            'PrimarySource': params['source'], \
                            'InputArtifacts': params['source'], \
                            'runorder': params['runorder']}}
                        
                        stages_temp.append(configuration)
                        envs = []
                        if 'env' in params:
                            envs.append(params.get('env'))
                        
                        list_codebuild.append(codebuild.create_codebuild(temp_name, temp_name, envs, params.get('imagemcustom')))
                    
                    
                    if t_codebuild != 'source':
                        tstage = custom[0]
                        t_build_template = [item for item in pipeline_template if item.split('-')[1] == tstage][0]
                        for l_codebuild_template in pipeline_template[t_build_template]:
                            for g_codebuild in l_codebuild_template:
                                new_codebuild = eval(f'codebuild.{g_codebuild}(featurename=featurename,microservicename=microservicename,runtime=runtime,branchname=env, custom=buildcustom, imageCustom=imageCustom)')
                                list_codebuild.append(new_codebuild)
                        pipeline_template[t_build_template].extend(stages_temp)
                
                
                elif custom[0].lower() == 'custom':
                    stage_custom_used = True
                    stage_name = f'{cont_stage}.{action_custom}-{custom[1]}'
                    action_custom += 1
                    pipeline_template[stage_name] = []
                    for list_yaml in t_codebuild[name_custom_stage]:
                        temp_name = list(list_yaml.keys())[0]
                        imagemcustom = False
                        params = self.getparams_codebuild(list_yaml[temp_name])
                        configuration = {\
                            temp_name: {'ProjectName': temp_name, 'PrimarySource': params['source'], 'InputArtifacts': params['source'], \
                            'runorder': params['runorder']}}
                        stages_temp.append(configuration)
                        codebuildname = temp_name
                        envs = []
                        if 'env' in params:
                            envs.append(params.get('env'))
                        list_codebuild.append(codebuild.create_codebuild(codebuildname, codebuildname, envs, params.get('imagemcustom')))
                    
                    pipeline_template[stage_name].extend(stages_temp)
            if not stage_custom_used:
                cont_stage += 1
        return list_codebuild
    
    def generate_template(self, parameters, resources):
        template = Template()
        
        for param in parameters:
            template.add_parameter(param)
        
        for resource in resources:
            template.add_resource(resource)
        return template.to_json()
    
    def generate_sources(self, stages, env, reponame, role, sharedlibrary_release):
        action = {}
        pipeline = NewPipeline()
        shared_configuration = {'BranchName': sharedlibrary_release, 'RepositoryName': 'pipelineaws-sharedlibrary', 'PollForSourceChanges': 'false', 'OutputArtifacts': 'Libs'}
        action['Source'] = [pipeline.create_action('SharedLibrary', '1', shared_configuration, 'Source', role)]
        
        for t_codebuild in stages:
            if ('Source' in t_codebuild or 'Source::custom' in t_codebuild):
                if t_codebuild == 'Source':
                    configuration = {'RepositoryName': reponame, 'BranchName': env, 'OutputArtifacts': 'App'}
                if 'Source::custom' in t_codebuild:
                    configuration = {}
                    for config in t_codebuild['Source::custom']:
                        configuration.update(config)
                    if 'BranchName' not in configuration:
                        configuration.update({'BranchName': env})
                action['Source'].append(
                    pipeline.create_action(configuration['RepositoryName'], '1', configuration, 'Source'))
        return action
    
    def create_security_groups(self, projeto, branch):
        out_all_rule = ec2.SecurityGroupRule(IpProtocol=\
            'TCP', FromPort=0, ToPort=65535, CidrIp='0.0.0.0/0')
        
        sg = ec2.SecurityGroup(
            'SG', VpcId=\
            Ref('VPCID'), GroupName=\
            f'{projeto}-{branch}', GroupDescription=\
            'This security group is used to control access to the container', SecurityGroupIngress=\
            [out_all_rule])
        
        return [sg]
    
    def generate_action(self, list_codebuild, pipeline_template, reponame, env):
        pipeline = NewPipeline()
        action = {}
        for code in list_codebuild:
            title = code.title.lower()
            configuration = 0
            for k in pipeline_template:
                for t in pipeline_template[k]:
                    code_template = list(t.keys())[0]
                    code_template_env = f'{code_template}{env}'
                    if (code_template.lower() == title or code_template_env.lower() == title):
                        configuration = list(t.values())[0]
            runorder = configuration.pop('runorder')
            configuration['ProjectName'] = code.Name
            action[title] = pipeline.create_action(title.capitalize(), int(runorder), configuration, 'Build')
        return action
    
    def check_stage_not_env(self, stage, env):
        '''
        Stages que nao devem estar na pipeline devido o ambiente
        '''
        stages_not_env = {\
            'develop': ['DeployHomol', 'DeployProd'], \
            'master': ['DeployDev']}
        
        if stage in stages_not_env[env]:
            return False
        return True
    
    def generate_stage(self, pipeline_stages, list_action, env):
        pipeline = NewPipeline()
        stages = []
        for t_stage in sorted(pipeline_stages):
            control_stage = t_stage.split('-')[1]
            if self.check_stage_not_env(control_stage, env):
                if control_stage == 'Source':
                    l_stage = []
                    for stg in list_action[control_stage]:
                        l_stage.append(stg)
                    stages.append(pipeline.create_stage('Source', l_stage))
                else:
                    l_stage = []
                    for stg in pipeline_stages[t_stage]:
                        for name_stg in stg:
                            name_stg = name_stg.lower()
                            if name_stg in list_action:
                                l_stage.append(list_action[name_stg])
                    stages.append(pipeline.create_stage(control_stage, l_stage))
        return stages
    
    def generate_pipeline(self, list_stages, projeto):
        pipeline = NewPipeline()
        resource = pipeline.create_pipeline(projeto, self.codepipeline_role, list_stages)
        return resource
    
    def save_swap(self, projeto, template, env, account):
        path = 'swap'
        if not (os.path.isdir(path)):
            os.mkdir(path)
        if os.path.isdir(path):
            filename = f'{path}/{projeto}-{env}-{account}.json'
            
            with open(filename, 'w') as file:
                file.write(template)
        return filename
    
    def generate(self, **tparams):
        tp = tparams['tp']
        resources = []
        list_action = {}
        projeto_name = tp['params']['Projeto']
        pipeline_name = f'{projeto_name}-{tp['env']}'
        
        
        list_codebuild = self.generate_codebuild(tp['runtime'], tp['pipeline_stages'], tp['stages'], tp['params'], tp['env'], tp['imageCustom'])
        
        
        list_action.update(self.generate_sources(tp['stages'], tp['env'], projeto_name, self.DevSecOps_Role, tp['release']))
        list_action.update(self.generate_action(list_codebuild, tp['pipeline_stages'], projeto_name, tp['env']))
        
        
        list_stages = self.generate_stage(tp['pipeline_stages'], list_action, tp['env'])
        
        
        list_params = self.pipeline_parameter()
        
        
        resources.extend(list_codebuild)
        resources.extend(self.generate_pipeline(list_stages, pipeline_name))
        resources.extend(self.create_security_groups(projeto_name, tp['env']))
        
        
        template = self.generate_template(list_params, resources)
        
        
        filename = self.save_swap(projeto_name, template, tp['env'], tp['account'])
        return filename</pre>

    </div>
</body>
</html>